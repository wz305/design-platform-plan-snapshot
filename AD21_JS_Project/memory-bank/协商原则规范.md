# 协商原则（Negotiation Principles） — 用户 ⇄ AI 的互动规范

## 概述
协商是用户与 AI 之间的动态对话过程。协商以**用户提出需求**为起点，由 AI 主动进行多轮分析、设计与建议，持续与用户交互直到需求精确到可执行层级（函数级）。协商输出是 “可信任的执行命令”，并写入模块的 `module.blueprint.md`。

> 协商不是自动实现代码。未经用户最终确认，禁止生成/写入任何代码文件。

---

## 设计要点（总览）
1. **以用户为起点**：每次协商起始点必须是用户明确提出的需求或变更请求。  
2. **AI 创造性建议**：AI 必须主动提出至少 2 个可行方案（可包含变通与优化），说明优缺点。  
3. **阶段分层**：协商分 5 个阶段，阶段间必须完成确认后方可进入下一阶段。  
4. **阶段粒度**：不同阶段产生不同粒度的产物（从语义到函数级），产物写入模块 blueprint。  
5. **无关项隔离**：在协商期间，AI 不得引入 `.clinerules` 外的其它规则或无关实现细节作为讨论重点（构建脚本规则例外）。  
6. **持久化产物**：协商的最终产物必须以结构化 Markdown 写入 `modules/<module>/module.blueprint.md`，便于审阅、版本控制与后续实现。  
7. **信心与风险**：每一阶段输出必须包含信心评分（0-10）与风险提示。  
8. **不可越权**：AI 不得修改未在“执行命令”中明确列出的文件。  

---

## 五阶段协商（简要）
1. **语义协商（What）**：复述需求、列假设、列不确定点、给出 2~3 个高层方向。  
2. **结构协商（Where）**：确定文件/模块划分、主流程、替代结构建议。  
3. **接口协商（How-API）**：确定对外/内部接口、输入输出结构与错误行为。  
4. **节点协商（How-Node）**：函数级拆解，每个函数步骤、日志点、边界条件。  
5. **执行命令（Execute Plan）**：列出将修改的文件、每文件的具体操作、执行顺序、回滚方案；用户回复“确认执行”后才进行代码生成。

---

## 协商的行为约定（给 AI 的行为清单）
- 在每个阶段，输出需使用固定模板（参见 `blueprint-template.md`）。  
- AI 必须提供至少两个方案（主方案 + 备选方案），并给出各自的权衡。  
- AI 在协商中可以创新（提出新工具/算法/结构），但任何创新必须作为“建议”列出，且需要用户确认。  
- 每个阶段用户提出修改建议后需更新本阶段并再次提供新方案，直到用户确认当前方案。  
- 每个阶段结束须等待用户显式确认（确认语例如 “同意阶段 X” 或 “继续”）。  
- 所有协商文件应被版本控制（git），协商更新要生成合并说明。  

---

## 持久化位置与文件约定
- 模块协商产物存放于：`modules/<module>/module.blueprint.md`。  
- blueprint 文件应总是包含五阶段产物的逐项输出（结构化）。  
- `.clinerules/` 仍然保存全局规则（语法/构建/日志等），协商过程中以其为约束条件。  

---

## 例外
- 构建脚本规则（如编码转换、合并顺序）是基础约束，应始终被保留并可以在协商中引用，但不作为协商主题。  

---