# 📄 **技术上下文.md**

（技术栈、开发环境、工具使用的技术上下文）

````markdown
# Technical Context - 技术上下文

## 技术栈概览

### 核心技术
- **语言标准**：ES3 (JavaScript 1.5)
- **运行环境**：AD21 JScript Engine
- **模块系统**：大IIFE包裹模式（零配置）
- **构建方式**：简单文件拼接（按路径顺序）

### 开发工具
- **构建工具**：Node.js + 自定义构建脚本
- **测试框架**：Node.js + 自定义测试运行器
- **编码规范**：GB2312字符编码
- **版本控制**：Git

### 目标环境
- **主环境**：Altium Designer 21 JScript
- **特殊约束**：无window对象、无ES5+语法、单线程执行

## AD JScript环境特性

### 全局变量访问规则
```javascript
// ✅ 正确的AD环境访问方式
var config = window.ProjectConfig.get("key");
var levels = window.LOG_LEVELS;
var instance = new window.LoggerConfig(name);

// ❌ 错误的访问方式（在AD环境中返回undefined）
var config = ProjectConfig.get("key");
var levels = LOG_LEVELS;
var instance = new LoggerConfig(name);
```

### 支持的JavaScript特性
- **变量声明**：仅支持 `var`
- **函数定义**：仅支持 `function` 声明
- **循环结构**：仅支持传统 `for` 循环
- **字符串**：必须使用双引号
- **对象创建**：必须使用字面量 `{}` `[]`

### 不支持的特性
- **ES5+语法**：let、const、箭头函数、class
- **ES5+方法**：forEach、filter、reduce、map
- **现代API**：Promise、async、require、import
- **全局对象**：window、this作为全局变量

## 关键技术决策

### 1. 模块架构：大IIFE模式
```javascript
var ModuleName = (function(){
    // 私有变量和函数
    var _privateVar = "private";
    
    function _privateFunction() {
        // 内部逻辑
    }
    
    // 公共接口
    function create(options) {
        // 实现逻辑
    }
    
    // 返回模块接口
    return {
        create: create
    };
})();
```

### 2. 日志系统：安全UI输出模式
- **双重控制机制**：生成级 + 显示级控制
- **性能优化**：DEBUG关闭时100%性能提升
- **安全过滤**：敏感信息自动过滤
- **标准格式**：`[ModuleName][fileName][functionName] message`

### 3. 错误处理：禁止静默降级
- **完整生命周期日志**：START → SUCCESS/ERROR
- **上下文信息记录**：参数、内部状态、结果
- **异常必须记录**：所有错误都要输出到日志系统
- **禁止静默失败**：不允许忽略或隐藏错误

## 构建系统设计

### 文件组织结构
```
src/
├── core/              # 核心系统
│   ├── global-events.js
│   └── module-accessor.js
├── modules/           # 功能模块
│   ├── logger/       # 日志系统
│   ├── object-module/ # 对象管理
│   └── pcb-interfaces/ # PCB接口
└── json2.js          # JSON解析库

dist/
└── main.js           # 构建输出（GB2312编码）
```

### 构建流程
1. **文件收集**：按路径顺序读取所有.js文件
2. **内容合并**：按顺序拼接文件内容
3. **编码转换**：输出为GB2312编码
4. **完整性检查**：验证合并结果

### 依赖管理
- **加载顺序**：core → modules → 具体实现
- **模块访问**：构建后自动成为全局变量
- **依赖关系**：直接使用其他模块变量名

## 测试策略

### 多层次验证
1. **构建测试**：验证文件合并和编码转换
2. **单元测试**：验证各模块基本功能
3. **集成测试**：验证模块间协作
4. **AD环境专项测试**：验证目标环境兼容性

### 测试覆盖目标
- **代码覆盖率**：目标80%
- **功能覆盖率**：目标100%
- **环境兼容性**：目标100%

## 性能优化策略

### 日志系统优化
- **早期返回**：日志关闭时立即返回
- **批量输出**：减少I/O操作次数
- **条件编译**：根据环境调整日志级别

### 模块加载优化
- **零配置**：无需复杂依赖解析
- **直接访问**：构建后全局变量直接可用
- **最小开销**：无运行时模块系统开销

## 安全考虑

### 数据安全
- **敏感信息过滤**：自动识别并过滤敏感数据
- **权限控制**：UI信息输出权限管理
- **格式化输出**：防止注入攻击

### 代码安全
- **ES3限制**：避免现代JavaScript安全风险
- **静态分析**：构建时检查语法兼容性
- **运行时保护**：错误边界和异常处理

## 开发工具配置

### 编辑器设置
- **文件编码**：UTF-8（开发时）
- **输出编码**：GB2312（构建后）
- **缩进风格**：4空格
- **行结束符**：CRLF（Windows）

### 构建脚本
- **主构建**：`build.bat`
- **带测试构建**：`build-with-test.bat`
- **依赖分析**：`scripts/dependency-builder.js`
- **测试运行**：`scripts/test-runner.js`

## 技术债务管理

### 已解决的技术债务
1. **✅ AD环境兼容性问题**：全局变量访问修复
2. **✅ 日志系统window依赖**：移除window硬编码依赖
3. **✅ 规则体系复杂性**：简化为3个核心规则文件

### 当前技术债务
1. **模块迁移工作量**：现有模块需要迁移到新架构
2. **测试覆盖不足**：需要增加更多测试用例
3. **性能监控缺失**：需要添加运行时性能监控

## 最佳实践总结

### AD环境开发最佳实践
1. **全局变量访问**：始终使用`window.`前缀
2. **语法严格限制**：严格遵循ES3语法规范
3. **错误处理**：完整的日志记录和异常处理
4. **性能优化**：早期返回和条件执行

### 模块开发最佳实践
1. **大IIFE包裹**：标准模块结构
2. **接口最小化**：只暴露必要的公共方法
3. **私有封装**：内部实现完全私有
4. **依赖明确**：直接使用其他模块变量

### 测试最佳实践
1. **多层次验证**：构建→单元→集成→环境测试
2. **AD环境专项**：目标环境兼容性验证
3. **性能基准**：关键操作性能测试
4. **错误场景**：异常情况处理测试

## 技术演进路径

### 短期目标（本周）
- 完成CoreModule和TopologyModule迁移
- 简化构建系统，移除merge-order.json依赖
- 增加测试覆盖率到60%

### 中期目标（本月）
- 完成所有模块迁移
- 建立完整的性能监控系统
- 实现自动化测试流程

### 长期目标（本季度）
- 建立持续集成流程
- 完善文档体系
- 生产环境部署验证

````

**此文件记录技术上下文，技术栈变更时应及时更新。**
