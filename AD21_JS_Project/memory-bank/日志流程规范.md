# 📄 **logging-flow.mmd**  
（日志架构与调用流程）

```markdown
# Logging Architecture Diagram

```mermaid
flowchart TD

subgraph Logger
    L1[logger.debug()]
    L2[logger.info()]
    L3[logger.warn()]
    L4[logger.error()]
end

A[index.js] --> L1
A --> L2
A --> L3
A --> L4

B[core.js] --> L1
B --> L2
B --> L3
B --> L4

C[steps/*.js] --> L1
C --> L2

F1["Format: [Module][File][Function] message"] -.-> L1

subgraph UI_Integration
    UI1[UI Logger Display]
    UI2[Safe Output Filter]
    UI3[Error Display Panel]
end

L1 --> UI1
L4 --> UI3
L1 --> UI2
L2 --> UI2
L3 --> UI2
L4 --> UI2

subgraph Function_Lifecycle_Logging
    FL1[START: Parameters]
    FL2[CONTEXT: Internal State]
    FL3[SUCCESS: Return Value]
    FL4[ERROR: Exception Details]
end

L1 --> FL1
L1 --> FL2
L1 --> FL3
L4 --> FL4
```

## 核心日志规范

### 1. 函数生命周期日志
每个函数必须包含以下四个关键日志点：

```js
function functionName(param1, param2) {
    // START: 记录传入参数
    logger.debug("[ModuleName][fileName][functionName] START - params: " + JSON.stringify({
        param1: param1,
        param2: param2
    }));
    
    try {
        // CONTEXT: 记录关键内部状态
        logger.debug("[ModuleName][fileName][functionName] CONTEXT - internalState: " + JSON.stringify(internalState));
        
        // 函数逻辑
        var result = doSomething();
        
        // SUCCESS: 记录返回值
        logger.debug("[ModuleName][fileName][functionName] SUCCESS - result: " + JSON.stringify(result));
        return result;
        
    } catch (error) {
        // ERROR: 记录异常详情
        logger.error("[ModuleName][fileName][functionName] ERROR - " + error.message + " stack: " + error.stack);
        throw error;
    }
}
```

### 2. UI集成安全规范
- **安全过滤**：所有输出到UI的信息必须经过安全过滤
- **敏感信息脱敏**：密码、密钥等敏感信息必须脱敏
- **错误信息格式化**：错误信息必须格式化后才能显示给用户

### 3. 禁止静默处理
- **所有错误必须记录**：不允许catch后不记录日志
- **所有降级必须记录**：功能降级时必须记录原因和影响
- **所有异常必须包含上下文**：错误日志必须包含足够的上下文信息

## 日志级别使用指南

### DEBUG级别
- 函数开始和结束
- 关键内部状态变化
- 重要决策点
- 参数验证结果

### INFO级别
- 重要的业务流程节点
- 系统状态变化
- 用户操作确认

### WARN级别
- 功能降级
- 性能警告
- 配置问题

### ERROR级别
- 异常和错误
- 功能失败
- 系统异常

## UI日志显示模式

### 实时模式
- DEBUG信息显示在开发者面板
- ERROR信息显示在错误面板
- 用户操作反馈显示在主界面

### 过滤模式
- 根据用户权限过滤敏感信息
- 根据界面空间限制信息密度
- 根据上下文相关性过滤信息

### 历史模式
- 支持日志历史查询
- 支持错误追踪
- 支持性能分析
````
