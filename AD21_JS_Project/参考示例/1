# ğŸš€ **é€šç”¨æ¨¡å—åŸºç¡€æ¨¡æ¿ï¼ˆv2.0 é€šç”¨å¢å¼ºç‰ˆï¼‰**

> **è¯´æ˜**
>
> * ä¸ç»‘å®šæ—¥å¿—æ¨¡å—
> * ä¸ç»‘å®šä»»ä½•å¤–éƒ¨ä¾èµ–
> * å¯ç”¨äºä»»ä½•åœºæ™¯ï¼ˆç®—æ³•æ¨¡å—ã€ä¸šåŠ¡æ¨¡å—ã€æ•°æ®æ¨¡å—ã€AD äºŒæ¬¡å¼€å‘æ¨¡å—ï¼‰
> * å¸¦å®Œæ•´é’©å­ç³»ç»Ÿ
> * å¸¦å®Œæ•´æ³¨é‡Šï¼ˆVSCode é£æ ¼ï¼‰
> * ES3 ç¯å¢ƒ 100% å¯è¿è¡Œ

---

# âœ… **é€šç”¨æ¨¡å—æ¨¡æ¿ï¼ˆå¯ä½œä¸ºä½ é¡¹ç›®çš„æ ‡å‡†æ¯æ¿ï¼‰**

```js
/**
 * é€šç”¨æ¨¡å—åŸºç¡€æ¨¡æ¿ (v2.0)
 * 
 * ç‰¹ç‚¹ï¼š
 * - é€šç”¨æ€§æå¼ºï¼Œé€‚ç”¨äºå„ç§ç±»å‹çš„æ¨¡å—
 * - ES3/JScript 5.8 å…¼å®¹
 * - å¸¦ç”Ÿå‘½å‘¨æœŸï¼šcreate/init/run/destroy
 * - å¸¦å®Œæ•´ Hook ç³»ç»Ÿï¼šbefore/after init/run/destroy
 * - å¸¦çŠ¶æ€ç®¡ç†ä¸ä¸Šä¸‹æ–‡ç®¡ç†
 * - ä¸ä¾èµ–å¤–éƒ¨æ—¥å¿—æ¨¡å—ï¼ˆä½†å¯è½»æ¾ç»‘å®šï¼‰
 * 
 * æ¨èä½œä¸º AD ES3 é¡¹ç›®çš„â€œæ¨¡å—æ¯æ¿â€
 */

var BaseModule = (function () {

    // -------------------------------------------------------------
    // 1. é»˜è®¤é…ç½®
    // -------------------------------------------------------------

    var _defaultConfig = {
        moduleName: "BaseModule",
        autoInit: false,     // run æ—¶è‹¥æœª init æ˜¯å¦è‡ªåŠ¨ init
        autoTime: true       // æ˜¯å¦è®¡ç®—æ‰§è¡Œæ—¶é—´
    };

    // -------------------------------------------------------------
    // 2. å·¥å…·å‡½æ•°ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
    // -------------------------------------------------------------

    /**
     * å®‰å…¨æ£€æŸ¥å¯¹è±¡æ˜¯å¦ä¸ºéç©ºå¯¹è±¡
     * @param {*} obj ä»»æ„å€¼
     * @returns {Boolean}
     */
    function _isObject(obj) {
        return obj && typeof obj === "object";
    }

    /**
     * åˆå§‹åŒ–çŠ¶æ€ç»“æ„
     * @param {Object} inst æ¨¡å—å®ä¾‹
     */
    function _initializeState(inst) {
        inst.state = {
            initialized: false,
            running: false,
            destroyed: false,
            errorCount: 0,
            lastError: null
        };
    }

    /**
     * åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç»“æ„
     * @param {Object} inst æ¨¡å—å®ä¾‹
     */
    function _initializeContext(inst) {
        inst.context = {
            startTime: null,
            endTime: null,
            executionTime: 0
        };
    }

    // -------------------------------------------------------------
    // 3. æ ¸å¿ƒç”Ÿå‘½å‘¨æœŸæ–¹æ³•
    // -------------------------------------------------------------

    /**
     * åˆ›å»ºæ¨¡å—å®ä¾‹
     * @param {Object=} options å¯é€‰é…ç½®
     * @returns {Object} æ¨¡å—å®ä¾‹
     */
    function create(options) {
        if (!_isObject(options)) {
            options = {};
        }

        // åˆå¹¶é»˜è®¤é…ç½®ï¼ˆES3ï¼‰
        var cfg = {};
        var k;
        for (k in _defaultConfig) { cfg[k] = _defaultConfig[k]; }
        for (k in options) { cfg[k] = options[k]; }

        // åˆ›å»ºå®ä¾‹å¯¹è±¡
        var inst = {};

        inst.options = cfg;
        inst.moduleName = cfg.moduleName;

        // åˆå§‹åŒ–å†…éƒ¨ç»“æ„
        _initializeState(inst);
        _initializeContext(inst);

        // Hook ç»“æ„ï¼ˆå¯è¢«ç”¨æˆ·èµ‹å€¼ï¼‰
        inst.hooks = {
            // Init
            onBeforeInit: null,
            onAfterInit: null,

            // Run
            onBeforeRun: null,
            onAfterRun: null,

            // Destroy
            onBeforeDestroy: null,
            onAfterDestroy: null
        };

        // æš´éœ²ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç»™å®ä¾‹ï¼ˆæ”¯æŒç»§æ‰¿ï¼‰
        inst.init = function () { return init(inst); };
        inst.run = function () { return run(inst); };
        inst.destroy = function () { return destroy(inst); };

        return inst;
    }


    /**
     * åˆå§‹åŒ–æ¨¡å—
     * @param {Object} inst æ¨¡å—å®ä¾‹
     * @returns {Boolean}
     */
    function init(inst) {
        if (!inst || inst.state.destroyed) return false;

        // Hook: before init
        if (inst.hooks.onBeforeInit) {
            inst.hooks.onBeforeInit(inst);
        }

        try {
            inst.state.initialized = true;
            inst.context.startTime = new Date();

            // å…·ä½“åˆå§‹åŒ–é€»è¾‘ï¼ˆå­ç±»å¯æ”¹å†™ï¼‰
            var ok = _performInitialization(inst);

            // Hook: after init
            if (inst.hooks.onAfterInit) {
                inst.hooks.onAfterInit(inst, ok);
            }

            return ok;

        } catch (err) {
            inst.state.errorCount++;
            inst.state.lastError = err.message;
            return false;
        }
    }


    /**
     * è¿è¡Œæ¨¡å—ä¸»ä½“é€»è¾‘
     * @param {Object} inst æ¨¡å—å®ä¾‹
     * @returns {Object} æ‰§è¡Œç»“æœ
     */
    function run(inst) {
        if (!inst || inst.state.destroyed) {
            return { success: false, message: "Instance invalid" };
        }

        // è‡ªåŠ¨åˆå§‹åŒ–
        if (!inst.state.initialized && inst.options.autoInit) {
            if (!init(inst)) {
                return { success: false, message: "Auto initialization failed" };
            }
        }

        // Hook: before run
        if (inst.hooks.onBeforeRun) {
            inst.hooks.onBeforeRun(inst);
        }

        inst.state.running = true;

        var start = inst.options.autoTime ? new Date().getTime() : 0;

        try {
            var result = _executeMainLogic(inst);

            if (inst.options.autoTime) {
                inst.context.executionTime = new Date().getTime() - start;
                inst.context.endTime = new Date();
            }

            inst.state.running = false;

            // Hook: after run
            if (inst.hooks.onAfterRun) {
                inst.hooks.onAfterRun(inst, result);
            }

            return result;

        } catch (err) {
            inst.state.running = false;
            inst.state.errorCount++;
            inst.state.lastError = err.message;

            return {
                success: false,
                message: err.message
            };
        }
    }


    /**
     * é”€æ¯æ¨¡å—å®ä¾‹
     * @param {Object} inst æ¨¡å—å®ä¾‹
     * @returns {Boolean}
     */
    function destroy(inst) {
        if (!inst || inst.state.destroyed) return false;

        // Hook: before destroy
        if (inst.hooks.onBeforeDestroy) {
            inst.hooks.onBeforeDestroy(inst);
        }

        try {
            inst.state.destroyed = true;

            // è‹¥å­æ¨¡å—è¦é‡Šæ”¾èµ„æºï¼Œå¯æ”¹å†™æ­¤å‡½æ•°
            _performDestroy(inst);

            // æ¸…ç©ºæ‰€æœ‰å±æ€§
            for (var k in inst) {
                if (inst.hasOwnProperty(k)) {
                    inst[k] = null;
                }
            }

            // Hook: after destroy
            if (inst.hooks.onAfterDestroy) {
                inst.hooks.onAfterDestroy(inst);
            }

            return true;

        } catch (err) {
            return false;
        }
    }

    // -------------------------------------------------------------
    // 4. å¯è¢«å­æ¨¡å—è¦†ç›–çš„å†…éƒ¨é€»è¾‘ï¼ˆç±»ä¼¼è™šæ–¹æ³•ï¼‰
    // -------------------------------------------------------------

    /**
     * æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ï¼ˆå­æ¨¡å—å¯é‡å†™ï¼‰
     */
    function _performInitialization(inst) {
        return true;
    }

    /**
     * æ‰§è¡Œä¸»è¦é€»è¾‘ï¼ˆå­æ¨¡å—å¯é‡å†™ï¼‰
     */
    function _executeMainLogic(inst) {
        return {
            success: true,
            message: "Execution completed",
            data: null,
            time: inst.context.executionTime
        };
    }

    /**
     * æ‰§è¡Œé”€æ¯é€»è¾‘ï¼ˆå­æ¨¡å—å¯é‡å†™ï¼‰
     */
    function _performDestroy(inst) {
        return true;
    }

    // -------------------------------------------------------------
    // 5. å¯¼å‡º API
    // -------------------------------------------------------------

    return {
        create: create
    };

})();
```

---

# ğŸ§© **è¿™ä¸ªæ¨¡æ¿çš„ç‰¹ç‚¹æ€»ç»“ï¼ˆéå¸¸å…³é”®ï¼‰**

| ç‰¹æ€§        | è¯´æ˜                            |
| --------- | ----------------------------- |
| é€šç”¨æ€§æå¼º     | ä¸ç»‘å®šæ—¥å¿—ã€ä¸ç»‘å®š ADï¼Œå¯ç”¨äºä»»ä½•æ¨¡å—          |
| å…¨ç”Ÿå‘½å‘¨æœŸ     | create / init / run / destroy |
| Hook å®Œæ•´æ”¯æŒ | before/after init/run/destroy |
| ES3 å…¼å®¹    | å…¨éƒ¨ var + function + æ—  class   |
| å¯ç»§æ‰¿       | å­æ¨¡å—å¯è¦†ç›– 3 ä¸ªå†…éƒ¨æ–¹æ³•                |
| å¯æ‰©å±•       | æ‰€æœ‰å®ä¾‹éƒ½æ˜¯çº¯å¯¹è±¡ï¼Œå¯ä»»æ„æ‰©å±•å±æ€§             |
| å®‰å…¨æ€§é«˜      | é”™è¯¯è®¡æ•°ã€çŠ¶æ€ã€ä¸Šä¸‹æ–‡å…¨å°è£…                |

è¿™æ˜¯ä¸€ä¸ª **å¯ä»¥æˆä¸ºä½ æ•´ä¸ª AD ES3 æ¶æ„çš„æ ¸å¿ƒâ€œæ¨¡å—åŸºç±»â€**ã€‚

---
