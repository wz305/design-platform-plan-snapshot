# 📄 **01-核心开发规则.md**
# AD ES3 核心规则

以下规则为强制性，不可违背。用于保证所有输出的 JS 代码在 AD 环境中稳定运行。

---

## 🚫 严禁事项（AD环境约束）

### 绝对禁止的语法和API
- **严禁使用this作为全局变量**（AD环境不支持this）
- **严禁使用window**（AD环境不存在window对象）
- **严禁ES5+语法**：class、let、const、箭头函数
- **严禁ES5+方法**：forEach、filter、reduce、map
- **严禁require/import**（AD环境不支持模块导入）
- **严禁new Function()**（AD环境安全限制）
- **严禁Promise/async**（AD环境不支持异步）

### 文件操作限制
- **严禁读取大于50KB的文件**（性能和安全限制）
- **严禁直接操作dist/main.js**（文件过大，需通过测试脚本验证）

### 字符串和对象规范
- **必须使用双引号**：`"string"`，禁止单引号`'string'`
- **必须使用字面量**：`{}`、`[]`，禁止new Object()、new Array()

### 循环规范
- **必须使用传统for循环**：
  ```js
  for (var i = 0; i < arr.length; i++) {}
  ```
- **严禁forEach等ES5+循环方法**

---

## ✅ 基础语法规范

### 变量声明
- **必须使用var声明变量**
- **禁止let、const**

### 函数定义
- **必须使用function声明**：
  ```js
  function functionName() {}
  ```
- **禁止箭头函数和函数表达式**

### DFM函数特殊规则
- **必须直接在全局作用域定义**：
  ```js
  function Button1Click(Sender) {
      // 处理逻辑
  }
  ```
- **必须包含Sender参数**
- **严禁使用IIFE包装**

---

## 📝 日志记录规范（强制性）

### 标准日志格式
- **必须使用标准日志格式**：
  ```js
  "[ModuleName][fileName][functionName] message"
  ```

### 完整函数日志
- **所有函数必须包含完整的debug日志**：
  ```js
  function functionName(param1, param2) {
      logger.debug("[ModuleName][fileName][functionName] START - params: " + JSON.stringify({
          param1: param1,
          param2: param2
      }));
      
      try {
          // 函数逻辑
          var result = doSomething();
          
          logger.debug("[ModuleName][fileName][functionName] SUCCESS - result: " + JSON.stringify(result));
          return result;
          
      } catch (error) {
          logger.error("[ModuleName][fileName][functionName] ERROR - " + error.message);
          throw error;
      }
  }
  ```

### 错误处理规范
- **严禁静默处理降级**：
  - 所有错误必须记录到日志系统
  - 所有异常必须包含上下文信息
  - 不允许静默失败或忽略错误
  - 必须输出关键内部状态到日志

### UI信息输出安全规范
- UI信息输出必须采用安全方式
- 敏感信息必须过滤或脱敏
- 日志系统与UI绑定时的安全约束

---

## ⚠️ AD环境特殊说明

### 环境限制
- **单线程执行**：无多线程支持
- **JScript 5.8**：相当于ES3语法
- **无现代API**：不支持ES5+标准库
- **全局作用域**：所有变量在同一个全局空间

### 兼容性要求
- **所有代码必须能合并为单个文件执行**
- **不能依赖外部模块系统**
- **必须能在IIFE环境中运行**（DFM函数除外）
- **模块变量在构建后自动成为全局变量**
- **模块间可以直接互相访问**

---

## 🎯 开发目标

1. **稳定性**：代码在AD环境中100%可运行
2. **简洁性**：使用最简单的ES3语法，优先选择简单模式
3. **可维护性**：清晰的模块结构，避免过度工程化
4. **可扩展性**：按需使用复杂架构，遵循KISS和YAGNI原则

---

## 📋 架构选择原则

### 模块设计原则：
- **一个模块一个文件**：清晰的文件组织
- **大IIFE包裹**：完全的内部封装
- **返回接口对象**：明确的模块边界
- **直接模块依赖**：构建后自动可访问

### 禁止过度工程化：
- 不要拆分过细的文件结构
- 不要创建不必要的中间导出变量
- 不要使用复杂的环境检测
- 不要暴露不必要的内部实现

---

## 🔗 相关规范

- **模块架构详细规范**：参考 `03-模块架构规则.md`
- **协商流程规范**：参考 `02-协商流程规则.md`
- **工作流规范**：参考 `04-工作流规则.md`

````

**记住：违背这些规则将导致代码在AD环境中无法运行！**
