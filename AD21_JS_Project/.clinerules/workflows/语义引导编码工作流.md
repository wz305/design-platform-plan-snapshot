# 语义引导编码工作流（Semantic-Guided Coding Workflow）

## 🎯 工作流目标与适用范围

**核心目标**：将语义系统从"分析工具"升级为"写代码的前置门禁"，强制Cline只能在语义系统允许的世界里写代码。

**适用范围**：所有ES3项目的代码修改、模块创建、函数定义、变量操作等。

**约束原则**：Gate First / Facts Only / No Assumption

---

## 🏛️ 核心原则（Gate First / Facts Only / No Assumption）

### ✅ Gate First - 门禁优先
- **禁止绕过语义检查**：任何代码修改前必须通过Capability Gate
- **强制符号存在性验证**：不允许假设任何符号存在
- **强制可达性检查**：不允许访问未验证的模块关系
- **强制计划驱动**：所有操作必须基于Execution Plan

### ✅ Facts Only - 仅基于事实
- **禁止假设行为**：不允许猜测运行时状态
- **禁止假设接口**：不允许假设未声明的API
- **禁止假设依赖**：不允许假设模块依赖关系
- **禁止假设参数**：不允许假设函数签名

### ✅ No Assumption - 禁止假设
- **禁止运行时推断**：不承诺值状态、生命周期等动态信息
- **禁止动态路径分析**：只分析静态可达性
- **禁止权限推断**：只检查静态访问权限
- **禁止行为假设**：不假设AD内部实现细节

---

## 📋 工作流总览（6个强制阶段）

### 🔍 阶段1：Capability Gate（能力门禁）
**目标**：确认目标对象、方法、模块是否真实存在且可被使用

**强制执行**：
```bash
# 必须执行的门禁检查
cd analyzer && node semantic-workflow.js check-callable --object <TargetObject>
cd analyzer && node semantic-workflow.js list-methods --module <TargetModule>
cd analyzer && node semantic-workflow.js can-access --from <Source> --to <Target>
```

**成功条件**：
- ✅ 目标对象存在且可调用
- ✅ 方法列表成功获取
- ✅ 访问权限静态可达

**失败行为**：
- ❌ 对象不存在 → **立即停止**
- ❌ 方法不可达 → **立即停止**
- ❌ 访问越权 → **立即停止**

---

### 🔍 阶段2：Semantic Validation（语义合法性验证）
**目标**：验证调用是否在语义上合法、可达、无作用域冲突

**强制执行**：
```bash
# 必须执行的语义验证
cd analyzer && node semantic-workflow.js can-access --from <CurrentModule> --to <TargetModule>
cd analyzer && node semantic-workflow.js predict-impact --symbol <TargetSymbol>
```

**成功条件**：
- ✅ 静态可达性验证通过
- ✅ 无作用域冲突
- ✅ 影响风险可控

**失败行为**：
- ❌ 不可达 → **拒绝生成代码**
- ⚠️ 可达但高风险 → **标记requires-approval**
- ❌ 作用域冲突 → **拒绝生成代码**

---

### 🎯 阶段3：Impact Prediction（影响预测）
**目标**：在写代码前预测可能受影响的符号、模块与风险等级

**强制执行**：
```bash
# 必须执行的影响预测
cd analyzer && node semantic-workflow.js predict-impact --symbol <TargetSymbol> --action <ActionType>
```

**成功条件**：
- ✅ 影响范围明确
- ✅ 风险等级评估完成
- ✅ 无critical级别阻断

**失败行为**：
- ❌ critical且无替代方案 → **停止**
- ⚠️ high → **标记风险并继续**
- ✅ low/medium → **进入计划阶段**

---

### 📋 阶段4：Execution Plan Generation（执行计划生成）
**目标**：不写代码，只生成"计划"

**强制执行**：
```bash
# 必须生成执行计划
cd analyzer && node semantic-workflow.js generate-plan --intent <IntentType> --symbol <TargetSymbol>
cd analyzer && node semantic-workflow.js simulate-plan --plan <PlanID>
```

**允许的Intent类型（枚举，不可扩展）**：
- `add-method-call` - 添加方法调用
- `remove-unused-symbol` - 移除未使用符号
- `rename-symbol` - 重命名符号
- `extract-helper-function` - 提取辅助函数
- `refactor-module-internal` - 模块内部重构

**成功条件**：
- ✅ 计划生成成功
- ✅ 安全检查通过
- ✅ 模拟执行成功

**失败行为**：
- ❌ 安全检查失败 → **停止**
- ❌ 不可回滚步骤 → **要求确认**
- ❌ Intent类型无效 → **拒绝生成**

---

### ✍️ 阶段5：Plan-Compliant Code Writing（按计划合规写代码）
**目标**：只能实现Execution Plan中定义的步骤

**⚠️ 红字声明**：
> ❗ **本工作流不自动修改代码**
> 所有代码修改行为由Cline执行，但必须逐条符合Execution Plan

**强制约束**：
- 只能实现Execution Plan中定义的步骤
- 不得新增未在Plan中出现的符号
- 不得修改未声明的模块
- 每个修改点必须可追溯到Plan Step ID

**成功条件**：
- ✅ 代码修改完全符合计划
- ✅ 无计划外的符号引入
- ✅ 无计划外的模块修改

**失败行为**：
- ❌ 偏离Execution Plan → **立即回滚**
- ❌ 引入未声明符号 → **立即回滚**
- ❌ 修改未授权模块 → **立即回滚**

---

### 🔍 阶段6：Post-Write Semantic Verification（事后语义回归验证）
**目标**：验证修改后的代码仍然在语义系统可解释范围内

**强制执行**：
```bash
# 必须执行的事后验证
cd analyzer && node semantic-workflow.js validate-capability
cd analyzer && node corrected-symbols-overview.js
cd analyzer && node capability-index-builder.js
```

**成功条件**：
- ✅ 无新增未声明符号
- ✅ 无破坏Capability Contract
- ✅ 语义索引更新成功

**失败行为**：
- ❌ 新增未声明符号 → **回滚**
- ❌ 破坏能力契约 → **回滚**
- ❌ 语义索引不一致 → **回滚**

---

## 🚨 Failure Handling & Abort Rules（强制中断规则）

### ❌ 立即中断条件
任一阶段返回以下状态时，Cline必须停止写代码并向用户报告原因：

1. **`BLOCKING`** - 阻塞性问题
2. **`CRITICAL`** - 关键风险
3. **`GATE_FAILED`** - 门禁检查失败
4. **`SEMANTIC_INVALID`** - 语义不合法

### 📋 中断报告格式
```markdown
## 🚨 语义工作流中断

**中断阶段**：[阶段名称]
**中断原因**：[具体原因]
**错误类型**：[BLOCKING/CRITICAL/GATE_FAILED/SEMANTIC_INVALID]

**建议行动**：
- [具体修复建议]
- [是否需要人工介入]

**影响范围**：
- [受影响的模块/符号]
```

### ❗ 禁止行为
- ❌ **不允许"先写再补语义"**
- ❌ **不允许"假设符号存在"**
- ❌ **不允许"临时绕过Gate"**
- ❌ **不允许"自定义Intent类型"**

---

## 📊 What This Workflow Does NOT Do（工作流边界）

### ❌ 不承诺的能力
- 运行时值状态推断
- AD内部对象生命周期模拟
- 参数值合法性验证
- 动态执行路径分析
- 内存使用情况预测

### ✅ 承诺的能力
- 静态可达性分析
- 符号存在性检查
- 方法签名推断
- 模块依赖分析
- 作用域边界识别

---

## 🔧 Compliance Statement（对Cline的硬约束）

### 🚫 强制约束条款

1. **门禁优先条款**：Cline在执行任何代码修改前，必须先通过semantic-workflow.js的所有Gate检查
2. **事实基础条款**：Cline只能基于Capability Index中声明的事实进行操作，禁止任何形式的假设
3. **计划驱动条款**：Cline的所有代码修改必须严格符合Execution Plan，禁止计划外的任何修改
4. **立即中断条款**：任何阶段返回BLOCKING/CRITICAL状态时，Cline必须立即停止并报告
5. **Intent枚举条款**：Cline只能使用预定义的5种Intent类型，禁止创造新类型
6. **事后验证条款**：Cline在每次代码修改后必须执行Post-Write验证

### ⚠️ 违规后果
- 任何违反上述条款的行为都将被视为对语义系统的破坏
- Cline有责任拒绝执行违反约束的代码修改请求
- 用户有权要求Cline重新遵循工作流约束

---

## 🛠️ 完整执行示例

### ✅ 合法修改示例
```bash
# 1. 确认目标存在
node semantic-workflow.js check-callable --object LoggerModule
# 输出：✅ 对象可调用

# 2. 验证访问权限
node semantic-workflow.js can-access --from LoggerModule --to ObjectModule
# 输出：✅ 静态可达

# 3. 预测影响
node semantic-workflow.js predict-impact --symbol deadVar
# 输出：✅ low风险

# 4. 生成执行计划
node semantic-workflow.js generate-plan --intent remove-unused-symbol --symbol deadVar
# 输出：✅ 计划生成成功

# 5. 按计划修改代码（Cline执行）
# 修改内容完全符合计划

# 6. 事后验证
node semantic-workflow.js validate-capability
# 输出：✅ 验证通过
```

### ❌ 违规示例
```bash
# 错误：跳过Gate直接写代码
# 违反：门禁优先条款

# 错误：假设符号存在
# 违反：事实基础条款

# 错误：自定义Intent类型
# 违反：Intent枚举条款

# 错误：不进行事后验证
# 违反：事后验证条款
```

---

## 📋 Intent类型定义（v1.0）

### 🔹 add-method-call
添加方法调用到现有模块
**前置条件**：目标模块存在，目标方法可调用
**风险评估**：low（标准操作）

### 🔹 remove-unused-symbol
移除未使用的符号（变量、函数、模块）
**前置条件**：符号确实未使用
**风险评估**：medium（可能影响依赖）

### 🔹 rename-symbol
重命名现有符号
**前置条件**：符号存在且无命名冲突
**风险评估**：high（影响所有引用）

### 🔹 extract-helper-function
从复杂函数中提取辅助函数
**前置条件**：源函数存在，可安全分解
**风险评估**：low（重构操作）

### 🔹 refactor-module-internal
模块内部重构
**前置条件**：模块存在，重构范围明确
**风险评估**：medium（内部操作）

---

## 🎯 工作流执行检查清单

### 每次修改必须执行的检查：
- [ ] 阶段1：Capability Gate通过
- [ ] 阶段2：Semantic Validation通过
- [ ] 阶段3：Impact Prediction完成
- [ ] 阶段4：Execution Plan生成
- [ ] 阶段5：按Plan修改代码
- [ ] 阶段6：Post-Write验证通过

### 中断条件检查：
- [ ] 无BLOCKING状态
- [ ] 无CRITICAL状态
- [ ] 无GATE_FAILED状态
- [ ] 无SEMANTIC_INVALID状态

---

## 📈 版本与演进

### v1.0（当前版本）
- 实现6阶段强制工作流
- 5种预定义Intent类型
- 完整的Gate和验证机制
- 强制中断和回滚规则

### 未来扩展方向
- 智能Intent推断（基于上下文）
- 自动化影响分析
- 增量验证机制
- 与IDE深度集成

---

## 🔗 相关文件与工具

### 核心工具
- `analyzer/semantic-workflow.js` - CLI工作流工具
- `analyzer/corrected-symbols-overview.js` - 符号分析
- `analyzer/capability-index-builder.js` - 能力索引构建

### 配置文件
- `analyzer/reports/capability-index-v1.json` - 能力索引
- `analyzer/reports/corrected-symbols-overview.json` - 符号总览

### 相关规范
- `.clinerules/01-核心开发规则.md` - ES3语法约束
- `.clinerules/03-模块架构规则.md` - 模块设计规范
- `.clinerules/04-工作流规则.md` - 工作流全局规则

---

**⚠️ 重要提醒**：本工作流文件是"宪法级"约束，一旦生效，所有后续的语义系统扩展和工具开发都必须严格遵循这些原则。任何违反都将被视为对整个语义系统架构的破坏。
