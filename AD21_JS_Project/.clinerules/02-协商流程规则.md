# 📄 **02-协商规则.md**

（协商流程和触发规则）

````markdown
# 协商规则

## 协商触发条件

当用户在对话中明确发出以下关键词时，AI 应自动启动相应的协商流程：

### 🚀 **创建模块**
- **触发词**："创建模块"、"新建模块"、"写个模块"、"协商"
- **流程**：启动五阶段模块创建协商
- **参考**：memory-bank/negotiation-principles.md

### 🔄 **修改模块**
- **触发词**："修改模块"、"更新模块"、"重构模块"
- **流程**：启动模块修改协商
- **参考**：memory-bank/negotiation-principles.md

### 🤝 **协商**
- **触发词**："协商"、"讨论"、"商量"
- **流程**：启动通用协商流程
- **参考**：memory-bank/negotiation-principles.md

## 协商流程规范

### 五阶段协商流程
1. **需求分析阶段**：理解用户具体需求
2. **架构设计阶段**：基于大IIFE模块模式设计模块结构
3. **实现方案阶段**：制定具体实现计划
4. **验证测试阶段**：确定测试策略
5. **确认执行阶段**：用户确认后开始实施

### 协商原则
- **必须参考**：memory-bank/negotiation-principles.md
- **必须使用**：大IIFE模块模式（参考03-模块导出规则.md）
- **必须遵循**：01-核心规则.md和03-模块导出规则.md中的所有约束
- **必须记录**：协商过程和决策结果

## 协商输出要求

### 模块蓝图生成
- 自动创建/更新 `modules/<module>/module.blueprint.md`
- 包含完整的模块设计文档
- 包含信心评分与风险说明
- 必须符合大IIFE模块模式规范

### 确认机制
- 每阶段结束必须等待用户"确认阶段X"
- 未经用户"确认执行"，禁止写入任何源文件
- 协商过程中仅引用.clinerules中的规则

## 特殊协商场景

### DFM函数协商
- **特殊要求**：必须直接在全局作用域定义
- **参数要求**：必须包含(Sender)参数
- **位置要求**：必须在src/core/global-events.js中定义
- **模块依赖**：可以直接使用构建后的全局模块变量

### 日志系统协商
- **当前状态**：日志系统存在问题，需要重构
- **重构方向**：基于大IIFE模块模式重新设计
- **优先级**：高优先级，影响整个项目
- **架构要求**：必须遵循03-模块导出规则.md中的规范

## 协商失败处理

### 无法达成一致
- 记录分歧点
- 提供备选方案
- 保留协商记录供后续参考

### 需求变更
- 重新启动协商流程
- 更新模块蓝图
- 确保所有变更符合核心规则

````

**记住：协商是确保项目质量和一致性的关键环节！**
