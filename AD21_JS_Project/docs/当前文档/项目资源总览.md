项目总览（目录、构建、运行入口、关键约束）

目录

- 源码：`AD21_JS_Project/src/`
- 构建产物（AD侧合并加载）：`AD21_JS_Project/dist/main.js`、`AD21_JS_Project/dist/main.dfm`、`AD21_JS_Project/dist/Main.PrjScr`
- Node侧测试脚本：`AD21_JS_Project/tests/`
- 调试/语义分析工具链：`AD21_JS_Project/debug/`、`AD21_JS_Project/analyzer/`
- 规范（主版本）：`AD21_JS_Project/docs/规范/Spec-0.1all.md`（AD 侧传输协议完成）；基础：`AD21_JS_Project/docs/规范/Spec-0.1.md`
- 一键测试：`AD21_JS_Project/docs/一键测试流程.md`
- 里程碑：`AD21_JS_Project/reports/Milestone-0_最小闭环完成.md`

构建/运行入口（已确认文件）

- AD：`AD21_JS_Project/dist/Main.PrjScr` + `AD21_JS_Project/dist/main.dfm` + `AD21_JS_Project/dist/main.js`
- Node：以“单文件require测试脚本”为主（例如 `AD21_JS_Project/tests/module-dependency-test.js`）
  
构建规则（最小产物）

- 构建脚本：`AD21_JS_Project/build/build.js`（或 `npm run build`）
- 构建前置：依赖检测（`AD21_JS_Project/scripts/dependency-builder.js`）
- 产物限定：仅输出 `main.js` / `main.dfm` / `Main.PrjScr`（全部 GB2312）
- DFM 来源：`AD21_JS_Project/ui/main.dfm`
- 项目文件来源：`AD21_JS_Project/ui/Main.PrjScr`

关键约束（项目级）

- 模块即接口：对外能力只应通过“导出表（Export Surface）”暴露；不要依赖未导出的内部符号。
- ES3/AD 环境限制：在AD JScript 5.8（ES3）环境中，避免ES5+特性（如 `Object.defineProperty`、严格模式等）；若不可避免必须显式标注“未确认/不兼容风险”。
- 日志/错误统一通道：优先落到 `memLog`（UI控件）与/或文件日志（LoggerModule + StepWrite）；不得随意 `alert` 或静默吞错（以代码为准）。
- 对接索引（机器可消费）：`reports/exports-index.json`（生成脚本：`node scripts/generate-exports-index.js` 或 `npm run exports-index`）。

阶段状态

- 当前闭环：已完成 Spec0.1 一键验证最小闭环（AD ↔ Node ↔ Browser）。
- 下一阶段：对象池/Wrapper 深化（对象池统一、Track/Via/Pad 细化、ad.object.get 调试命令）。

实现要点（近期落地）

- 按文档树修正 PCBServer/GetCurrentPCBBoard、IPCB_Board 迭代器、PrimitiveCounter 的调用方式，避免误用 Schematic 文档路径。
- BOARD_SUMMARY 计数路径：PrimitiveCounter -> GetPrimitiveCount -> BoardIterator_Create（按文档示例顺序兜底）。
- AD 侧 JSON 解析采用 JsonUtil + __adJsonParse 例外点，避免 JSON.parse 不可用导致的 non-json 误判。
- 宿主全局桥：__adGetHostGlobal + 全局符号桥，避免合并产物里遮蔽 PCBServer 等全局。

模块地图（按域分组）

core

- ModuleAccessor：`AD21_JS_Project/docs/当前文档/模块文档/core/ModuleAccessor.md`
- BaseModule：`AD21_JS_Project/docs/当前文档/模块文档/core/BaseModule.md`
- Core：`AD21_JS_Project/docs/当前文档/模块文档/core/Core.md`
- global-events：`AD21_JS_Project/docs/当前文档/模块文档/core/global-events.md`
- HTTPClientModule：`AD21_JS_Project/docs/当前文档/模块文档/core/HTTPClientModule.md`
- EnvironmentProbeModule：`AD21_JS_Project/docs/当前文档/模块文档/core/EnvironmentProbeModule.md`
- simple-global-events：`AD21_JS_Project/docs/当前文档/模块文档/core/simple-global-events.md`

logger

- LoggerTypes：`AD21_JS_Project/docs/当前文档/模块文档/logger/LoggerTypes.md`
- LoggerTools：`AD21_JS_Project/docs/当前文档/模块文档/logger/LoggerTools.md`
- StepFormat：`AD21_JS_Project/docs/当前文档/模块文档/logger/StepFormat.md`
- StepWrite：`AD21_JS_Project/docs/当前文档/模块文档/logger/StepWrite.md`
- LoggerModule：`AD21_JS_Project/docs/当前文档/模块文档/logger/LoggerModule.md`
- LoggerModuleIndex：`AD21_JS_Project/docs/当前文档/模块文档/logger/LoggerModuleIndex.md`
- GlobalLogController：`AD21_JS_Project/docs/当前文档/模块文档/logger/GlobalLogController.md`
- UILoggerModule：`AD21_JS_Project/docs/当前文档/模块文档/logger/UILoggerModule.md`
- SimpleLoggerModule：`AD21_JS_Project/docs/当前文档/模块文档/logger/SimpleLoggerModule.md`
- SimpleLoggerIndex：`AD21_JS_Project/docs/当前文档/模块文档/logger/SimpleLoggerIndex.md`

pcb

- PCBInterfaces：`AD21_JS_Project/docs/当前文档/模块文档/pcb/PCBInterfaces.md`
- BasePCBWrapper：`AD21_JS_Project/docs/当前文档/模块文档/pcb/BasePCBWrapper.md`
- PCBMockSystem：`AD21_JS_Project/docs/当前文档/模块文档/pcb/PCBMockSystem.md`
- PCBObjectFactory：`AD21_JS_Project/docs/当前文档/模块文档/pcb/PCBObjectFactory.md`
- PCBObjectManager：`AD21_JS_Project/docs/当前文档/模块文档/pcb/PCBObjectManager.md`
- PCBObjectPool：`AD21_JS_Project/docs/当前文档/模块文档/pcb/PCBObjectPool.md`
- StackMap：`AD21_JS_Project/docs/当前文档/模块文档/pcb/StackMap.md`
- GeometryCalculator：`AD21_JS_Project/docs/当前文档/模块文档/pcb/GeometryCalculator.md`
- ArcWrapper：`AD21_JS_Project/docs/当前文档/模块文档/pcb/ArcWrapper.md`
- PadWrapper：`AD21_JS_Project/docs/当前文档/模块文档/pcb/PadWrapper.md`
- TrackWrapper：`AD21_JS_Project/docs/当前文档/模块文档/pcb/TrackWrapper.md`
- ViaWrapper：`AD21_JS_Project/docs/当前文档/模块文档/pcb/ViaWrapper.md`

ui

- UIModule：`AD21_JS_Project/docs/当前文档/模块文档/ui/UIModule.md`
- ObjectCreatorWindow：`AD21_JS_Project/docs/当前文档/模块文档/ui/ObjectCreatorWindow.md`
- ObjectCreatorUI：`AD21_JS_Project/docs/当前文档/模块文档/ui/ObjectCreatorUI.md`
- UIEventManager：`AD21_JS_Project/docs/当前文档/模块文档/ui/UIEventManager.md`
- MainFormDFM：`AD21_JS_Project/docs/当前文档/模块文档/ui/MainFormDFM.md`
- ObjectCreatorFormDFM：`AD21_JS_Project/docs/当前文档/模块文档/ui/ObjectCreatorFormDFM.md`

analyzer

- SemanticWorkflow：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/SemanticWorkflow.md`
- SemanticAnalyzer：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/SemanticAnalyzer.md`
- Interpreter：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/Interpreter.md`
- ActionPlanner：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/ActionPlanner.md`
- ASTParser：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/ASTParser.md`
- TopLevelScanner：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/TopLevelScanner.md`
- SymbolTypes：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/SymbolTypes.md`
- DependencyAnalyzer：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/DependencyAnalyzer.md`
- DefUseAnalyzer：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/DefUseAnalyzer.md`
- ProjectIndex：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/ProjectIndex.md`
- CapabilityIndexBuilder：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/CapabilityIndexBuilder.md`
- CapabilityQueryValidator：`AD21_JS_Project/docs/当前文档/模块文档/analyzer/CapabilityQueryValidator.md`
- 其余 analyzer 子模块：见目录 `AD21_JS_Project/docs/当前文档/模块文档/analyzer/`

tests/debug（tests-debug）

- debug/runtime/ad-mock：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/debug-runtime-ad-mock.md`
- debug/test-functions：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/debug-test-functions.md`
- debug/cli/semantic-debug：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/debug-cli-semantic-debug.md`
- debug/cli/jalangi2-semantic：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/debug-cli-jalangi2-semantic.md`
- debug/__tests__/mvp-test：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/debug-__tests__-mvp-test.md`
- debug/__tests__/jalangi2-semantic-test：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/debug-__tests__-jalangi2-semantic-test.md`
- analyzer/demo-*：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/analyzer-demo-full-build-check.md` 等（同目录其余文档）
- analyzer/test-* & analyzer/tests/*：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/analyzer-test-query-apis.md` 等（同目录其余文档）
- tests/*.js（Node 侧合并/自检脚本）：`AD21_JS_Project/docs/当前文档/模块文档/tests-debug/tests-full-module-test.md` 等（同目录其余文档）

“可用资源”四张表

可直接调用 API

模块	入口	核心可调用API	环境	备注
BaseModule	src/modules/base/index.js	create/init/run/destroy	Both	生命周期骨架
LoggerModuleIndex	src/modules/logger/index.js	getDefaultLogger/flush/getStats	Both	日志门面（依赖LoggerModule核心）
PCBInterfaces	src/modules/pcb-interfaces/index.js	initialize/createWrapper/createMock	Both	PCB封装门面（存在已知接口不一致，见模块文档）
UIModule	ui/index.js	initializeUI/showObjectCreatorWindow/getStatus	AD	UI门面（依赖DFM与全局uiInfo）
ObjectCreatorUI	ui/core/ObjectCreatorUI.js	initialize/showWindow/handleCreateObject	AD	对象创建窗体逻辑（当前走Mock创建路径）
SemanticWorkflow	analyzer/semantic-workflow.js	analyzeProject/executeCommand/generatePlan	Node	语义工作流门面（会读文件并可能退出进程）
ASTParser	analyzer/ast/parser.js	parseFile/parseFiles	Node	ES3/ES5 AST 解析（Node）
TopLevelScanner	analyzer/semantic/top-level-scanner.js	scanTopLevelSymbols/isIIFEModule	Node	抽取顶层符号与IIFE模块识别
SymbolTypes	analyzer/semantic/symbol-types.js	createBaseSymbol/createDiagnostic/validateSymbol	Node	符号类型与诊断结构
DependencyAnalyzer	analyzer/semantic/dependency-analyzer.js	buildDependencyGraph/detectCircularDependencies	Node	依赖分析与报告生成（Node）
Interpreter	analyzer/interpreter.js	interpret/executePlan（未确认）	Node	解释器/执行（细节见模块文档）

UI 入口

入口/事件	定义位置	环境	副作用	备注
DFM全局事件函数（大量）	src/core/global-events.js	AD	读写memLog/调用日志与PCB模块	详见 `AD21_JS_Project/docs/当前文档/模块文档/core/global-events.md`
主窗体（MainForm）	ui/main.dfm	AD	提供memLog与按钮事件入口	事件函数在`src/core/global-events.js`
对象创建窗体（ObjectCreatorForm）	ui/object-creator.dfm	AD	对象类型/位置/参数输入；触发创建	按钮OnClick绑定到`src/core/global-events.js`
最小通信测试按钮	btnHttpSmokeTest (ui/object-creator.dfm)	AD	触发HTTP ping/command/Spec v0.1	事件：`btnHttpSmokeTestClick` → `测试_AD_Spec_0_1_一键验证`
环境探测按钮	btnEnvironmentProbe (ui/main.dfm)	AD	触发环境探测	事件：`btnEnvironmentProbeClick` → `测试_运行环境探测`
对象创建窗口门面	ObjectCreatorWindow（ui/object-creator.js）	AD	调用UIModule显示/隐藏窗体	详见 `AD21_JS_Project/docs/当前文档/模块文档/ui/ObjectCreatorWindow.md`

可运行脚本

脚本	位置	如何运行	产物/输出	备注
一键启动_最小闭环	scripts/一键启动_最小闭环.cmd	双击或 `cmd /c scripts/一键启动_最小闭环.cmd`	浏览器打开 /status	Node Mock + 浏览器 UI
模块依赖测试	tests/module-dependency-test.js	`node tests/module-dependency-test.js`	`reports/module-dependency-test-report.json`	会写报告并输出控制台摘要
全量构建检查（语义）	analyzer/demo-full-build-check.js	`node analyzer/demo-full-build-check.js`	`analyzer/reports/full-build-analysis-report.json`	读取 `config/merge-order.json` 并生成报告
执行计划校验（语义）	analyzer/demo-execution-validation.js	`node analyzer/demo-execution-validation.js`	`analyzer/reports/execution-planner-validation-report.json` + `.md`	会在失败时 `process.exit(1)`（线索：`execution-planner-validation-report`）
能力查询 API 测试	analyzer/test-query-apis.js	`node analyzer/test-query-apis.js`	临时文件 `query-api-test.js`（会删除）	顶层执行脚本；失败 `process.exit(1)`
Stage5 集成测试	analyzer/test-stage5-integration.js	`node analyzer/test-stage5-integration.js`	`reports/stage5-integration-test-report.txt`	顶层执行脚本
Stage6 闭环测试	analyzer/test-stage6-closed-loop.js	`node analyzer/test-stage6-closed-loop.js`	控制台输出	导出函数也可被require（见模块文档）
Jalangi 语义调试（trace）	debug/cli/semantic-debug.js	`node debug/cli/semantic-debug.js trace`	`debug/traces/trace.json`	另有 explain 子命令（见 `debug/README.md`）
Jalangi2 语义分析	debug/cli/jalangi2-semantic.js	`node debug/cli/jalangi2-semantic.js`	`debug/reports/jalangi2-semantic-report.json`	会在失败时 `process.exit(exitCode)`
Jalangi2 语义测试（Node）	debug/__tests__/jalangi2-semantic-test.js	`node debug/__tests__/jalangi2-semantic-test.js`	`debug/reports/jalangi2-semantic-test-report.json`	失败 `process.exit(1)` / 最终以退出码表示成功与否
MVP 端到端测试（Node）	debug/__tests__/mvp-test.js	`node debug/__tests__/mvp-test.js`	`debug/traces/test-trace.json`	依赖 `debug/runtime/ad-mock.js`
合并包完整性测试	tests/full-module-test.js	`node tests/full-module-test.js`	控制台输出	加载合并包并检查全局导出（细节见模块文档）
合并包综合测试	tests/comprehensive-module-test.js	`node tests/comprehensive-module-test.js`	控制台输出	同上
合并包完成性测试	tests/complete-module-test.js	`node tests/complete-module-test.js`	控制台输出	同上

Mock 资源

资源	位置	用途	环境	备注
AD常量/运行时Mock	debug/runtime/ad-mock.js	提供AD常量/接口模拟	Node	用于语义/运行时分析（具体依赖链待补齐）
PCB对象Mock系统	src/modules/pcb-interfaces/core/PCBMockSystem.js	创建Mock原生对象	Both	存在ES3兼容性风险（Object.defineProperty）
Analyzer 测试夹具	analyzer/tests/test-files/	用于 analyzer/tests/* 生成/读取的临时文件	Node	会被测试脚本创建/覆盖（见各 tests 文档）
环境探测报告上传	web-mock/mock-server-es3.js	POST /api/upload-report → reports/environment-probe-report-<timestamp>.json	Node	用于AD环境探测报告归档

关键链路（构建→加载→UI→PCB→日志→报告→测试）

- 构建：源码（src）合并为 `dist/main_utf8.js`（加载顺序受 merge-order.json 控制；线索：构建系统文档/脚本待整理）
- 加载：AD通过 `Main.PrjScr`/DFM加载并在全局暴露模块变量（window/global）
- UI：DFM事件 → `src/core/global-events.js` 全局函数 → 调用 Logger/UI Logger/PCBInterfaces/ObjectCreatorModule 等
- PCB：PCBInterfaces → PCBObjectFactory/PCBMockSystem/BasePCBWrapper/(Arc|Pad|Track|Via)Wrapper → 访问/修改原生IPC对象
- Spec：`docs/规范/Spec-0.1all.md`（主版本）→ Wrapper.toSpec/applySpec → AD API
- 日志：GlobalLogController 生成/显示开关 → LoggerModule/UILoggerModule → UI(memLog) 与/或 StepWrite 文件写入
- 报告：
  - analyzer：`analyzer/reports/*`（示例：`analyzer/reports/full-build-analysis-report.json`、`analyzer/reports/execution-planner-validation-report.json`）
  - debug：`debug/reports/*`、`debug/traces/*`（示例：`debug/traces/trace.json`、`debug/reports/jalangi2-semantic-report.json`）
- 测试：`tests/*.js`、`debug/__tests__/*.js`、`analyzer/test-*.js` 在 Node 侧执行（见“可运行脚本”表）
